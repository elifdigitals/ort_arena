<!DOCTYPE html>
<html lang="ru">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>ORT Arena - Duels</title>
      <link rel="stylesheet" href="src/css/duels.css">
</head>
<body>
      <header class="header">
            <nav class="nav">
                  <div class="logo">ORT_Arena</div>
                  <ul class="nav-links">
                  <li><a href="home_page.html">Home Page</a></li>
                  <li><a href="/problems">Problems</a></li>
                  <li><a href="contests.html">Contests</a></li>
                  <li><a href="#" class="active">Duels</a></li>
                  <li><a href="/leaderboard">Leaderboard</a></li>
                  </ul>
            </nav>
      </header>

      <div class="container">
            <div class="page-header">
                  <h1>–î—É—ç–ª–∏</h1>
                  <p>–í—ã–∑–æ–≤–∏ –¥—Ä—É–≥–∞ –Ω–∞ –ø–æ–µ–¥–∏–Ω–æ–∫ 1 –Ω–∞ 1!</p>
            </div>

            <div class="action-card">
                  <h2>–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –¥—É—ç–ª—å</h2>
                  <p>–ë—Ä–æ—Å—å –≤—ã–∑–æ–≤ –¥—Ä—É–≥–æ–º—É –∏–≥—Ä–æ–∫—É –∏ –¥–æ–∫–∞–∂–∏ —Å–≤–æ—ë –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ</p>
                  <button class="btn btn-primary" onclick="openChallengeModal()">
                  –í—ã–∑–≤–∞—Ç—å –Ω–∞ –¥—É—ç–ª—å
                  </button>
            </div>

            <div class="tabs">
                  <button class="tab-btn active" data-tab="incoming">–í—Ö–æ–¥—è—â–∏–µ –≤—ã–∑–æ–≤—ã</button>
                  <button class="tab-btn" data-tab="my-challenges">–ú–æ–∏ –≤—ã–∑–æ–≤—ã</button>
                  <button class="tab-btn" data-tab="active">–ê–∫—Ç–∏–≤–Ω—ã–µ –¥—É—ç–ª–∏</button>
                  <button class="tab-btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
            </div>

            <div id="incoming" class="duels-section active">
                  <div id="incoming-duels"></div>
            </div>

            <div id="my-challenges" class="duels-section">
                  <div id="my-challenges-duels"></div>
            </div>

            <div id="active" class="duels-section">
                  <div id="active-duels"></div>
            </div>

            <div id="history" class="duels-section">
                  <div id="history-duels"></div>
            </div>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ -->
      <div id="challengeModal" class="modal">
            <div class="modal-content">
                  <div class="modal-header">–í—ã–∑–≤–∞—Ç—å –Ω–∞ –¥—É—ç–ª—å</div>
                  <div class="form-group">
                  <label class="form-label">–í—ã–±–µ—Ä–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</label>
                  <input type="text" class="form-input" id="opponentSearch" 
                        placeholder="–í–≤–µ–¥–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." 
                        oninput="searchUsers(this.value)">
                  <div id="userSuggestions" class="user-suggestions" style="display:none;"></div>
                  </div>
                  <div class="duel-actions">
                  <button class="btn btn-primary" onclick="sendChallenge()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤</button>
                  <button class="btn btn-secondary" onclick="closeChallengeModal()">–û—Ç–º–µ–Ω–∞</button>
                  </div>
            </div>
      </div>

      <script>
            let selectedOpponent = null;

            // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const tempDuels = {
                  incoming: [
                  {
                        id: 1,
                        challenger: { username: '–ê–π–¥–∞—Ä –ë–µ–∫–º—É—Ä–∞—Ç–æ–≤', rating: 2450 },
                        opponent: { username: '–¢—ã', rating: 1845 },
                        status: 'pending',
                        created_at: '2024-12-04T14:30:00'
                  },
                  {
                        id: 2,
                        challenger: { username: '–ù—É—Ä–∞–π –ê—Å–∞–Ω–æ–≤–∞', rating: 2380 },
                        opponent: { username: '–¢—ã', rating: 1845 },
                        status: 'pending',
                        created_at: '2024-12-04T12:15:00'
                  }
                  ],
                  'my-challenges': [
                  {
                        id: 3,
                        challenger: { username: '–¢—ã', rating: 1845 },
                        opponent: { username: '–≠–º–∏—Ä –¢–æ–∫—Ç–æ–º—É—à–µ–≤', rating: 2315 },
                        status: 'pending',
                        created_at: '2024-12-04T10:00:00'
                  }
                  ],
                  active: [
                  {
                        id: 4,
                        challenger: { username: '–¢—ã', rating: 1845 },
                        opponent: { username: '–ë–µ–∫–±–æ–ª–æ—Ç –ò—Å–∞–µ–≤', rating: 1920 },
                        status: 'in_progress',
                        started_at: '2024-12-04T15:00:00',
                        time_left: '5 –º–∏–Ω—É—Ç'
                  }
                  ],
                  history: [
                  {
                        id: 5,
                        challenger: { username: '–¢—ã', rating: 1845 },
                        opponent: { username: '–ê–ª–∏–Ω–∞ –ñ—É–º–∞–±–∞–µ–≤–∞', rating: 1780 },
                        status: 'finished',
                        winner: '–¢—ã',
                        finished_at: '2024-12-03T18:30:00'
                  },
                  {
                        id: 6,
                        challenger: { username: '–î–∞–Ω–∏—è—Ä –û—Å–º–æ–Ω–æ–≤', rating: 2100 },
                        opponent: { username: '–¢—ã', rating: 1845 },
                        status: 'finished',
                        winner: '–î–∞–Ω–∏—è—Ä –û—Å–º–æ–Ω–æ–≤',
                        finished_at: '2024-12-02T16:45:00'
                  }
                  ]
            };

            const tempUsers = [
                  { username: '–ê–π–¥–∞—Ä –ë–µ–∫–º—É—Ä–∞—Ç–æ–≤', rating: 2450 },
                  { username: '–ù—É—Ä–∞–π –ê—Å–∞–Ω–æ–≤–∞', rating: 2380 },
                  { username: '–≠–º–∏—Ä –¢–æ–∫—Ç–æ–º—É—à–µ–≤', rating: 2315 },
                  { username: '–ë–µ–∫–±–æ–ª–æ—Ç –ò—Å–∞–µ–≤', rating: 1920 },
                  { username: '–ê–ª–∏–Ω–∞ –ñ—É–º–∞–±–∞–µ–≤–∞', rating: 1780 }
            ];

            function getInitials(name) {
                  return name.split(' ').map(n => n[0]).join('').toUpperCase();
            }

            function formatDate(dateString) {
                  const date = new Date(dateString);
                  const now = new Date();
                  const diff = Math.floor((now - date) / 1000 / 60);
                  
                  if (diff < 60) return `${diff} –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥`;
                  if (diff < 1440) return `${Math.floor(diff / 60)} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥`;
                  return `${Math.floor(diff / 1440)} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
            }

            function renderDuel(duel, category) {
                  const isYouChallenger = duel.challenger.username === '–¢—ã';
                  let actions = '';
                  
                  if (category === 'incoming') {
                  actions = `
                        <button class="btn btn-success" onclick="acceptDuel(${duel.id})">
                              –ü—Ä–∏–Ω—è—Ç—å
                        </button>
                        <button class="btn btn-danger" onclick="rejectDuel(${duel.id})">
                              –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                  `;
                  } else if (category === 'active') {
                  actions = `
                        <button class="btn btn-primary" onclick="joinDuel(${duel.id})">
                              –í–æ–π—Ç–∏ –≤ –¥—É—ç–ª—å
                        </button>
                  `;
                  } else if (category === 'history') {
                  const isWinner = duel.winner === '–¢—ã';
                  actions = `
                        <button class="btn btn-secondary" onclick="viewDuelResults(${duel.id})">
                              –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        </button>
                  `;
                  }

                  let statusBadge = '';
                  let statusClass = '';
                  if (duel.status === 'pending') {
                  statusBadge = '–û–∂–∏–¥–∞–Ω–∏–µ';
                  statusClass = 'status-pending';
                  } else if (duel.status === 'in_progress') {
                  statusBadge = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                  statusClass = 'status-in-progress';
                  } else if (duel.status === 'finished') {
                  statusBadge = '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
                  statusClass = 'status-finished';
                  }

                  return `
                  <div class="duel-card">
                        <div class="duel-header">
                              <div class="duel-status-badge ${statusClass}">${statusBadge}</div>
                              <div style="color: #999; font-size: 14px;">
                              ${duel.created_at ? formatDate(duel.created_at) : ''}
                              </div>
                        </div>

                        <div class="duel-players">
                              <div class="player">
                              <div class="player-avatar">${getInitials(duel.challenger.username)}</div>
                              <div class="player-name">${duel.challenger.username}</div>
                              <div class="player-rating">‚≠ê ${duel.challenger.rating}</div>
                              </div>

                              <div class="vs-icon">‚öîÔ∏è</div>

                              <div class="player">
                              <div class="player-avatar">${getInitials(duel.opponent.username)}</div>
                              <div class="player-name">${duel.opponent.username}</div>
                              <div class="player-rating">‚≠ê ${duel.opponent.rating}</div>
                              </div>
                        </div>

                        ${duel.time_left ? `
                              <div class="duel-info">
                              <div class="info-row">
                                    <span class="info-label">‚è∞ –û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</span>
                                    <span class="info-value">${duel.time_left}</span>
                              </div>
                              </div>
                        ` : ''}

                        ${duel.winner ? `
                              <div class="duel-info">
                              <div class="info-row">
                                    <span class="info-label">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</span>
                                    <span class="info-value">${duel.winner}</span>
                              </div>
                              </div>
                        ` : ''}

                        <div class="duel-actions">
                              ${actions}
                        </div>
                  </div>
                  `;
            }

            function renderDuels(category) {
                  const container = document.getElementById(`${category}-duels`);
                  const duels = tempDuels[category];

                  if (!duels || duels.length === 0) {
                  container.innerHTML = `
                        <div class="empty-state">
                              <div class="empty-state-icon">üéÆ</div>
                              <h3>–î—É—ç–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                              <p>–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</p>
                        </div>
                  `;
                  return;
                  }

                  container.innerHTML = duels.map(duel => renderDuel(duel, category)).join('');
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.addEventListener('click', function() {
                  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                  document.querySelectorAll('.duels-section').forEach(s => s.classList.remove('active'));
                  
                  this.classList.add('active');
                  const tab = this.dataset.tab;
                  document.getElementById(tab).classList.add('active');
                  });
            });

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            function openChallengeModal() {
                  document.getElementById('challengeModal').classList.add('active');
            }

            function closeChallengeModal() {
                  document.getElementById('challengeModal').classList.remove('active');
                  document.getElementById('opponentSearch').value = '';
                  document.getElementById('userSuggestions').style.display = 'none';
                  selectedOpponent = null;
            }

            function searchUsers(query) {
                  const suggestions = document.getElementById('userSuggestions');
                  
                  if (!query) {
                  suggestions.style.display = 'none';
                  return;
                  }

                  const filtered = tempUsers.filter(user => 
                  user.username.toLowerCase().includes(query.toLowerCase())
                  );

                  if (filtered.length === 0) {
                  suggestions.style.display = 'none';
                  return;
                  }

                  suggestions.innerHTML = filtered.map(user => `
                  <div class="user-suggestion" onclick="selectOpponent('${user.username}', ${user.rating})">
                        <div class="suggestion-avatar">${getInitials(user.username)}</div>
                        <div>
                              <div style="font-weight: 600;">${user.username}</div>
                              <div style="font-size: 12px; color: #666;">‚≠ê ${user.rating}</div>
                        </div>
                  </div>
                  `).join('');

                  suggestions.style.display = 'block';
            }

            function selectOpponent(username, rating) {
                  selectedOpponent = { username, rating };
                  document.getElementById('opponentSearch').value = username;
                  document.getElementById('userSuggestions').style.display = 'none';
            }

            function sendChallenge() {
                  if (!selectedOpponent) {
                  alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞!');
                  return;
                  }
                  
                  alert(`–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫—É ${selectedOpponent.username}!`);
                  closeChallengeModal();
                  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –∑–∞–ø—Ä–æ—Å
            }

            function acceptDuel(id) {
                  alert(`–î—É—ç–ª—å #${id} –ø—Ä–∏–Ω—è—Ç–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...`);
                  // API –∑–∞–ø—Ä–æ—Å
            }

            function rejectDuel(id) {
                  alert(`–î—É—ç–ª—å #${id} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞`);
                  // API –∑–∞–ø—Ä–æ—Å
            }

            function joinDuel(id) {
                  window.location.href = `/duels/${id}/play`;
            }

            function viewDuelResults(id) {
                  window.location.href = `/duels/${id}/results`;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            renderDuels('incoming');
            renderDuels('my-challenges');
            renderDuels('active');
            renderDuels('history');
      </script>
</body>
</html>